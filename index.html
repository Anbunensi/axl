<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <title>烟花秀</title>
  <style>
    html,body{height:100%;margin:0;padding:0}
    ul,li{text-indent:0;text-decoration:none;margin:0;padding:0}
    img{border:0}
    body{background-color:#000;color:#999;font:100%/18px helvetica, arial, sans-serif}
    canvas{cursor:crosshair;display:block;left:0;position:absolute;top:0;z-index:20}
  </style>
</head>
<body>

<script type="text/javascript" src="jquery-2.0.0.min.js"></script>
<script type="text/javascript">
$(function(){

var Fireworks = function(){
  var self = this;
  var rand = function(rMi, rMa){return ~~((Math.random()*(rMa-rMi+1))+rMi);}
  var hitTest = function(x1, y1, w1, h1, x2, y2, w2, h2){return !(x1 + w1 < x2 || x2 + w2 < x1 || y1 + h1 < y2 || y2 + h2 < y1)};
  window.requestAnimFrame=function(){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(e){window.setTimeout(e,1e3/60)}}();

  self.init = function(){
    self.canvas = document.createElement('canvas');
    self.canvas.width = self.cw = $(window).innerWidth();
    self.canvas.height = self.ch = $(window).innerHeight();
    self.particles = [];
    self.partCount = 150;
    self.fireworks = [];
    self.mx = self.cw/2;
    self.my = self.ch/2;
    self.currentHue = 30;
    self.partSpeed = 5;
    self.partSpeedVariance = 10;
    self.partWind = 50;
    self.partFriction = 5;
    self.partGravity = 1;
    self.hueMin = 0;
    self.hueMax = 360;
    self.fworkSpeed = 4;
    self.fworkAccel = 10;
    self.hueVariance = 30;
    self.flickerDensity = 25;
    self.showShockwave = true;
    self.showTarget = false;
    self.clearAlpha = 25;

    $(document.body).append(self.canvas);
    self.ctx = self.canvas.getContext('2d');
    self.ctx.lineCap = 'round';
    self.ctx.lineJoin = 'round';
    self.lineWidth = 1;
    self.bindEvents();
    self.canvasLoop();

    self.canvas.onselectstart = function(){ return false; };
  };

  // 生成单个粒子（角度单位：度）
  self._spawnParticle = function(x,y,hue, angleDeg, speedOverride, overrides){
    var p = {
      x: x, y: y,
      coordLast: [{x:x,y:y},{x:x,y:y},{x:x,y:y}],
      angle: (typeof angleDeg==='number') ? angleDeg : rand(0,360),
      speed: (typeof speedOverride==='number')
              ? speedOverride
              : rand(((self.partSpeed - self.partSpeedVariance) <= 0) ? 1 : self.partSpeed - self.partSpeedVariance,
                     (self.partSpeed + self.partSpeedVariance)),
      friction: 1 - self.partFriction/100,
      gravity: self.partGravity/2,
      hue: hue,
      brightness: rand(50, 80),
      alpha: rand(40,100)/100,
      decay: rand(10, 50)/1000,
      wind: (rand(0, self.partWind) - (self.partWind/2))/25,
      lineWidth: self.lineWidth
    };
    if (overrides) for (var k in overrides) p[k] = overrides[k];
    self.particles.push(p);
  };

  // 默认环形
  self.createParticles = function(x,y,hue){
    var countdown = self.partCount;
    while(countdown--){
      var h = rand(hue - self.hueVariance, hue + self.hueVariance);
      self._spawnParticle(x,y,h, undefined, undefined);
    }
  };

  // 爱心（尖朝下 ❤）：在角度上整体旋转 180°
  self.createHeart = function(x,y,hue){
    var N = self.partCount;
    var jitter = Math.PI/60; // 轻微抖动
    var rMax = 20; // 近似最大半径
    for (var i=0;i<N;i++){ 
      var t = (i/N) * Math.PI * 2;
      var rx = 16*Math.pow(Math.sin(t),3);
      var ry = 13*Math.cos(t) - 5*Math.cos(2*t) - 2*Math.cos(3*t) - Math.cos(4*t);
      var angRad = Math.atan2(ry, rx) + (Math.random()*2-1)*jitter;
      angRad += Math.PI; // 旋转 180°，尖朝下
      var angDeg = angRad * 180 / Math.PI;
      var r = Math.sqrt(rx*rx + ry*ry);
      var spd = 4 + 3 * (r / rMax);
      var h = rand(hue - self.hueVariance, hue + self.hueVariance);
      self._spawnParticle(x,y,h, angDeg, spd, {
        friction: 0.985,
        gravity: 0.05,
        decay: rand(8,18)/1000,
        alpha: 0.9
      });
    }
  };

  // 星形（五角星射线）
  self.createStar = function(x,y,hue, spikes){
    spikes = spikes || 5;
    var baseAngles = [];
    for (var k=0;k<spikes;k++) baseAngles.push( (k/spikes)*Math.PI*2 );
    var N = self.partCount;
    var spread = Math.PI/(spikes*8);
    for (var i=0;i<N;i++){ 
      var base = baseAngles[rand(0,spikes-1)];
      var angRad = base + (Math.random()*2-1)*spread;
      var angDeg = angRad * 180 / Math.PI;
      var h = rand(hue - self.hueVariance, hue + self.hueVariance);
      self._spawnParticle(x,y,h, angDeg, rand(5,7), {
        friction: 0.975,
        gravity: 0.10
      });
    }
  };

  // 生成与父爆不同的色相（尽量不同）
  function differentHueFrom(baseHue){
    var offset = rand(60, 180) * (Math.random() < 0.5 ? -1 : 1);
    var h = (baseHue + offset) % 360;
    if (h < 0) h += 360;
    return h;
  }

  // 二次绽放：从(x,y)向外发射子火箭；childType 指定子火箭到达后的爆炸样式
  // 每个子火箭使用与父爆显著不同的随机颜色；子火箭不再继续分裂
  self.createSecondaries = function(x,y,parentHue, childType){
    var m = rand(6,12);
    for (var i=0;i<m;i++){
      var theta = Math.random()*Math.PI*2;
      var r = rand(60, 140);
      var tx = x + Math.cos(theta)*r;
      var ty = y + Math.sin(theta)*r;
      var childHue = differentHueFrom(parentHue);
      self.createFireworks(x, y, tx, ty, {
        noChildren: true,           // 子火箭不再分裂
        childType: childType || '', // 子火箭爆炸形状
        hue: childHue,              // 子火箭专属颜色
        lineWidth: 0.75,
        brightness: 60
      });
    }
  };

  // 爆炸样式：6种随机
  // 0: default, 1: heart, 2: star, 3: default+double, 4: heart+double, 5: star+double
  self._explodeAtFirework = function(f){
    var mode;
    if (f.childType) {
      // 子火箭只执行指定形状，不触发二爆
      mode = f.childType; // 'default' | 'heart' | 'star'
    } else {
      var r = Math.random();
      if (r < 1/6) mode = 'default';
      else if (r < 2/6) mode = 'heart';
      else if (r < 3/6) mode = 'star';
      else if (r < 4/6) mode = 'default_double';
      else if (r < 5/6) mode = 'heart_double';
      else mode = 'star_double';
    }

    if (mode === 'default') {
      self.createParticles(f.targetX, f.targetY, f.hue);
    } else if (mode === 'heart') {
      self.createHeart(f.targetX, f.targetY, f.hue);
    } else if (mode === 'star') {
      self.createStar(f.targetX, f.targetY, f.hue, 5);
    } else if (mode === 'default_double') {
      self.createParticles(f.targetX, f.targetY, f.hue);
      if (!f.noChildren) self.createSecondaries(f.targetX, f.targetY, f.hue, 'default');
    } else if (mode === 'heart_double') {
      self.createHeart(f.targetX, f.targetY, f.hue);
      if (!f.noChildren) self.createSecondaries(f.targetX, f.targetY, f.hue, 'heart');
    } else { // 'star_double'
      self.createStar(f.targetX, f.targetY, f.hue, 5);
      if (!f.noChildren) self.createSecondaries(f.targetX, f.targetY, f.hue, 'star');
    }
  };

  // 允许传入 opts（如 noChildren/childType/hue）
  self.createFireworks = function(startX, startY, targetX, targetY, opts){
    var hueToUse = (opts && typeof opts.hue === 'number')
      ? opts.hue
      : self.currentHue;
    var newFirework = {
      x: startX, y: startY, startX: startX, startY: startY,
      hitX: false, hitY: false,
      coordLast: [{x:startX,y:startY},{x:startX,y:startY},{x:startX,y:startY}],
      targetX: targetX, targetY: targetY,
      speed: self.fworkSpeed,
      angle: Math.atan2(targetY - startY, targetX - startX),
      shockwaveAngle: Math.atan2(targetY - startY, targetX - startX)+(90*(Math.PI/180)),
      acceleration: self.fworkAccel/100,
      hue: hueToUse,
      brightness: rand(50, 80),
      alpha: rand(50,100)/100,
      lineWidth: self.lineWidth
    };
    if (opts) for (var k in opts){ newFirework[k]=opts[k]; }
    self.fireworks.push(newFirework);
  };

  self.updateParticles = function(){
    var i = self.particles.length;
    while(i--){
      var p = self.particles[i];
      var radians = p.angle * Math.PI / 180; // 度→弧度
      var vx = Math.cos(radians) * p.speed;
      var vy = Math.sin(radians) * p.speed;
      p.speed *= p.friction;

      p.coordLast[2].x = p.coordLast[1].x;
      p.coordLast[2].y = p.coordLast[1].y;
      p.coordLast[1].x = p.coordLast[0].x;
      p.coordLast[1].y = p.coordLast[0].y;
      p.coordLast[0].x = p.x;
      p.coordLast[0].y = p.y;

      p.x += vx;
      p.y += vy;
      p.y += p.gravity;

      p.angle += p.wind;
      p.alpha -= p.decay;

      if(!hitTest(0,0,self.cw,self.ch,p.x-p.radius, p.y-p.radius, p.radius*2, p.radius*2) || p.alpha < .05){
        self.particles.splice(i, 1);
      }
    }
  };

  self.drawParticles = function(){
    var i = self.particles.length;
    while(i--){
      var p = self.particles[i];
      var coordRand = (rand(1,3)-1);
      self.ctx.beginPath();
      self.ctx.moveTo(Math.round(p.coordLast[coordRand].x), Math.round(p.coordLast[coordRand].y));
      self.ctx.lineTo(Math.round(p.x), Math.round(p.y));
      self.ctx.closePath();
      self.ctx.strokeStyle = 'hsla('+p.hue+', 100%, '+p.brightness+'%, '+p.alpha+')';
      self.ctx.stroke();

      if(self.flickerDensity > 0){
        var inverseDensity = 50 - self.flickerDensity;
        if(rand(0, inverseDensity) === inverseDensity){
          self.ctx.beginPath();
          self.ctx.arc(Math.round(p.x), Math.round(p.y), rand(p.lineWidth,p.lineWidth+3)/2, 0, Math.PI*2, false)
          self.ctx.closePath();
          var randAlpha = rand(50,100)/100;
          self.ctx.fillStyle = 'hsla('+p.hue+', 100%, '+p.brightness+'%, '+randAlpha+')';
          self.ctx.fill();
        }
      }
    }
  };

  self.updateFireworks = function(){
    var i = self.fireworks.length;
    while(i--){
      var f = self.fireworks[i];
      self.ctx.lineWidth = f.lineWidth;

      var vx = Math.cos(f.angle) * f.speed,
          vy = Math.sin(f.angle) * f.speed;
      f.speed *= 1 + f.acceleration;
      f.coordLast[2].x = f.coordLast[1].x;
      f.coordLast[2].y = f.coordLast[1].y;
      f.coordLast[1].x = f.coordLast[0].x;
      f.coordLast[1].y = f.coordLast[0].y;
      f.coordLast[0].x = f.x;
      f.coordLast[0].y = f.y;

      if(f.startX >= f.targetX){ if(f.x + vx <= f.targetX){ f.x = f.targetX; f.hitX = true; } else { f.x += vx; } }
      else { if(f.x + vx >= f.targetX){ f.x = f.targetX; f.hitX = true; } else { f.x += vx; } }

      if(f.startY >= f.targetY){ if(f.y + vy <= f.targetY){ f.y = f.targetY; f.hitY = true; } else { f.y += vy; } }
      else { if(f.y + vy >= f.targetY){ f.y = f.targetY; f.hitY = true; } else { f.y += vy; } }

      if(f.hitX && f.hitY){
        self._explodeAtFirework(f);
        self.fireworks.splice(i, 1);
      }
    }
  };

  self.drawFireworks = function(){
    var i = self.fireworks.length;
    self.ctx.globalCompositeOperation = 'lighter';
    while(i--){
      var f = self.fireworks[i];
      self.ctx.lineWidth = f.lineWidth;

      var coordRand = (rand(1,3)-1);
      self.ctx.beginPath();
      self.ctx.moveTo(Math.round(f.coordLast[coordRand].x), Math.round(f.coordLast[coordRand].y));
      self.ctx.lineTo(Math.round(f.x), Math.round(f.y));
      self.ctx.closePath();
      self.ctx.strokeStyle = 'hsla('+f.hue+', 100%, '+f.brightness+'%, '+f.alpha+')';
      self.ctx.stroke();

      if(self.showTarget){
        self.ctx.save();
        self.ctx.beginPath();
        self.ctx.arc(Math.round(f.targetX), Math.round(f.targetY), rand(1,8), 0, Math.PI*2, false)
        self.ctx.closePath();
        self.ctx.lineWidth = 1;
        self.ctx.stroke();
        self.ctx.restore();
      }

      if(self.showShockwave){
        self.ctx.save();
        self.ctx.translate(Math.round(f.x), Math.round(f.y));
        self.ctx.rotate(f.shockwaveAngle);
        self.ctx.beginPath();
        self.ctx.arc(0, 0, 1*(f.speed/5), 0, Math.PI, true);
        self.ctx.strokeStyle = 'hsla('+f.hue+', 100%, '+f.brightness+'%, '+rand(25, 60)/100+')';
        self.ctx.lineWidth = f.lineWidth;
        self.ctx.stroke();
        self.ctx.restore();
      }
    }
  };

  self.bindEvents = function(){
    $(window).on('resize', function(){
      clearTimeout(self.timeout);
      self.timeout = setTimeout(function() {
        self.canvas.width = self.cw = $(window).innerWidth();
        self.canvas.height = self.ch = $(window).innerHeight();
        self.ctx.lineCap = 'round';
        self.ctx.lineJoin = 'round';
      }, 100);
    });

    $(self.canvas).on('mousedown', function(e){
      self.mx = e.pageX - self.canvas.offsetLeft;
      self.my = e.pageY - self.canvas.offsetTop;
      self.currentHue = rand(self.hueMin, self.hueMax);
      self.createFireworks(self.cw/2, self.ch, self.mx, self.my);

      $(self.canvas).on('mousemove.fireworks', function(e){
        self.mx = e.pageX - self.canvas.offsetLeft;
        self.my = e.pageY - self.canvas.offsetTop;
        self.currentHue = rand(self.hueMin, self.hueMax);
        self.createFireworks(self.cw/2, self.ch, self.mx, self.my);
      });
    });

    $(self.canvas).on('mouseup', function(){
      $(self.canvas).off('mousemove.fireworks');
    });

    // 触摸支持
    function posFromTouch(t, el){
      var r = el.getBoundingClientRect();
      return { x: t.clientX - r.left, y: t.clientY - r.top };
    }
    self.canvas.addEventListener('touchstart', function(e){
      var t = e.touches[0]; if(!t) return;
      var p = posFromTouch(t, self.canvas);
      self.currentHue = rand(self.hueMin, self.hueMax);
      self.createFireworks(self.cw/2, self.ch, p.x, p.y);
      e.preventDefault();
    }, {passive:false});
    self.canvas.addEventListener('touchmove', function(e){
      var t = e.touches[0]; if(!t) return;
      var p = posFromTouch(t, self.canvas);
      self.currentHue = rand(self.hueMin, self.hueMax);
      self.createFireworks(self.cw/2, self.ch, p.x, p.y);
      e.preventDefault();
    }, {passive:false});
  };

  self.clear = function(){
    self.particles = [];
    self.fireworks = [];
    self.ctx.clearRect(0, 0, self.cw, self.ch);
  };

  self.canvasLoop = function(){
    requestAnimFrame(self.canvasLoop, self.canvas);
    self.ctx.globalCompositeOperation = 'destination-out';
    self.ctx.fillStyle = 'rgba(0,0,0,'+self.clearAlpha/100+')';
    self.ctx.fillRect(0,0,self.cw,self.ch);
    self.updateFireworks();
    self.updateParticles();
    self.drawFireworks();
    self.drawParticles();
  };

  self.init();
};

// 暴露实例（可扩展用）
window.fworks = new Fireworks();

});
</script>

<div style='height:20px;text-align:center;font-size:18px;margin-top:10px;'><b>烟花秀</b></div>
</body>
</html>
